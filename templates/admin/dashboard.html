{% extends 'admin/layouts/template.html' %}

{% block page_title %}Dashboard - Admin{% endblock %}

{% block content %}
<div class="section-dashboard container-fluid mt-3 mb-5">
    <!-- Key Metrics Cards -->
    <div class="row mt-1 g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Model Aktif</p>
                            <h5 class="fw-bold mb-0" id="modelVersion">ARIMAX v1.0</h5>
                            <small class="text-success" id="modelAccuracy">MAPE: -</small>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-brain text-primary fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Total Data</p>
                            <h3 class="fw-bold mb-0" id="totalRecords">0</h3>
                            <small class="text-muted" id="yearRange">
                                records (...)
                            </small>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                            <i class="fas fa-database text-success fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-start border-info border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">R² Score</p>
                            <h4 class="fw-bold mb-0" id="r2Score">-</h4>
                            <small class="text-muted" id="r2Label">Model fit quality</small>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded">
                            <i class="fas fa-chart-line text-info fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Trend</p>
                            <h5 class="fw-bold mb-0" id="trendIndicator">
                                <i class="fas fa-arrow-up text-danger"></i>
                                <span id="trendValue">-</span>
                            </h5>
                            <small class="text-muted">Perubahan per tahun</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                            <i class="fas fa-chart-area text-warning fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Row -->
    <div class="row mb-4">
        <!-- Prediction Chart -->
        <div class="col-lg-7 mb-4">
            <!-- Title Card -->
            <div class="card shadow-sm mb-3">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1 fw-bold">
                                <i class="fas fa-chart-line text-primary me-2"></i>
                                Grafik Prediksi Konsumsi Energi Fosil
                            </h5>
                            <span class="badge bg-success" id="scenarioText">
                                <i class="fas fa-check-circle me-1"></i>
                                Menggunakan Moderat ( GDP Growth +5.37% / tahun )
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Card -->
            <div class="card shadow-sm" style="border: 2px solid #0d6efd;">
                <div class="card-body p-4">
                    <div id="predictionChartContainer" style="height: 450px;">
                        <canvas id="predictionChart"></canvas>
                    </div>
                    <div class="mt-3 text-center">
                        <span class="badge bg-primary me-2">
                            <i class="fas fa-circle me-1" style="font-size: 0.6rem;"></i>Data Aktual
                        </span>
                        <span class="badge bg-danger me-2">
                            <i class="fas fa-circle me-1" style="font-size: 0.6rem;"></i>Prediksi
                        </span>
                        <span class="badge bg-secondary">
                            <i class="fas fa-square me-1" style="font-size: 0.6rem; opacity: 0.3;"></i>Confidence
                            Interval (95%)
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Performance & Quick Stats -->
        <div class="col-lg-5">
            <!-- Model Performance -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-tachometer-alt text-success me-2"></i>
                        Performa Model
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="fw-bold">MAPE (Akurasi)</small>
                            <small class="text-success" id="mapeValue">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" id="mapeBar" style="width: 0%"></div>
                        </div>
                        <!-- Penjelasan singkat tentang MAPE -->
                        <div class="mt-2">
                            <div class="mt-1">
                                <small id="mapeDescription" class="fw-bold"></small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="fw-bold">R² Score</small>
                            <small class="text-info" id="r2Value">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" id="r2Bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Grafik kecil: Actual vs Predicted (Test Set) -->
                    <div class="mt-3">
                        <small class="fw-bold">Perbandingan Data Asli & Prediksi (Test Set):</small>
                        <div style="height: 120px;">
                            <canvas id="miniComparisonChart"></canvas>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-muted d-block">RMSE</small>
                            <strong id="rmseValue">-</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">MAE</small>
                            <strong id="maeValue">-</strong>
                        </div>
                    </div>

                    <div class="mt-3">
                        <small class="fw-bold">Penjelasan Evaluasi Model</small>
                        <div class="d-inline-block px-4 py-3 mt-2"
                            style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-radius: 12px; border-left: 4px solid #01384F; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-info-circle" style="font-size: 1.2rem; color: #01384F;"></i>
                                <small class="text-muted">
                                    Kinerja model dievaluasi menggunakan <strong>MAPE, R², RMSE, dan MAE</strong>.
                                    Nilai <strong>MAPE</strong> menunjukkan rata-rata persentase kesalahan prediksi,
                                    sedangkan <strong>R²</strong> mengukur kemampuan model dalam menjelaskan variasi
                                    data historis. Semakin <strong>rendah MAPE</strong> dan <strong>tinggi R²</strong>,
                                    <strong>semakin baik performa model dalam melakukan prediksi</strong>.
                                </small>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <!-- Last Training Info -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-history text-warning me-2"></i>
                        Last Training
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted"><i class="fas fa-calendar me-2"></i>Tanggal:</td>
                            <td class="text-end"><strong id="lastTrainingDate">-</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted"><i class="fas fa-code me-2"></i>Parameters:</td>
                            <td class="text-end"><code id="modelParams">-</code></td>
                        </tr>
                        <tr>
                            <td class="text-muted"><i class="fas fa-clock me-2"></i>Duration:</td>
                            <td class="text-end"><strong id="trainingDuration">-</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Data vs Prediction Comparison -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-chart-bar text-primary me-2"></i>
                        Actual vs Predicted (Test Set)
                    </h6>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-table text-secondary me-2"></i>
                        Preview Prediksi Mendatang
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-hover table-bordered table-sm mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Tahun</th>
                                    <th>Prediksi (TWh)</th>
                                    <th>Lower Bound</th>
                                    <th>Upper Bound</th>
                                    <th>Perubahan</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="predictionTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Memuat data prediksi...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grafik Data Asli vs GDP -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-chart-area text-success me-2"></i>
                        Grafik Data GDP
                    </h6>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="gdpChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-chart-area text-success me-2"></i>
                        Grafik Data Energi
                    </h6>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Recent Activities & Quick Actions -->
    <div class="row">
        <!-- Recent Activities -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-list text-info me-2"></i>
                            Aktivitas Terbaru
                        </h6>
                        <a href="/admin/riwayat" class="btn btn-sm btn-outline-primary">
                            Lihat Semua
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="timeline" id="recentActivities">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Memuat aktivitas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & System Status -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-bolt text-warning me-2"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/admin/scraping-data" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-download me-2"></i>Update Data
                        </a>
                        <a href="/admin/update-model" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-brain me-2"></i>Retrain Model
                        </a>
                        <button class="btn btn-outline-info btn-sm" onclick="generateReport()">
                            <i class="fas fa-file-pdf me-2"></i>Generate Report
                        </button>
                        <a href="/admin/riwayat" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-history me-2"></i>Lihat Riwayat
                        </a>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-server text-danger me-2"></i>
                        System Status
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Database</span>
                        <span class="badge bg-success" id="databaseStatus">
                            <i class="fas fa-check-circle"></i> Online
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Model Server</span>
                        <span class="badge bg-success" id="modelServerStatus">
                            <i class="fas fa-check-circle"></i> Running
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">API Status</span>
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle"></i> Active
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notificationToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-bell me-2"></i>
            <strong class="me-auto">Notifikasi</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Pesan notifikasi
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    let charts = {};

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadDashboardData();
        updateLastUpdateTime();
        loadGDPScenario();
    });

    // Load all dashboard data
    function loadDashboardData() {
        loadModelInfo();
        loadPredictionData();
        loadRecentActivities();
        loadSystemStatus();
        loadActualAndGDPData(); // <-- panggil API untuk grafik Data Asli vs GDP
    }

    function loadGDPScenario() {
        fetch('/api/gdp/scenario')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById("sim-scenario");

                    select.options[0].text =
                        `Moderat (${data.moderate}% per tahun)`;

                    select.options[1].text =
                        `Optimis (${data.optimistic}% per tahun)`;

                    select.options[2].text =
                        `Pesimis (${data.pessimistic}% per tahun)`;

                    // Update scenarioText with moderate value on load
                    const scenarioText = document.getElementById("scenarioText");
                    if (scenarioText) {
                        scenarioText.innerHTML = `Moderat (+${data.moderate}%/tahun)`;
                    }
                }
            })
            .catch(err => console.error("Scenario error:", err));
    }

    // Fungsi ambil data asli dan GDP dari database
    function loadActualAndGDPData() {
        fetch('/api/dashboard/actual-gdp')
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    // Tampilkan error khusus jika endpoint tidak ditemukan
                    throw new Error('ENDPOINT_NOT_FOUND');
                }
            })
            .then(data => {
                console.log('DATA API /api/dashboard/actual-gdp:', data);

                // Tampilkan grafik meskipun data.gdp kosong, asalkan array
                if (
                    data &&
                    Array.isArray(data.actual) && data.actual.length > 0 &&
                    Array.isArray(data.gdp)
                ) {
                    createEnergyChart(data.actual);
                    createGDPChart(data.gdp);


                    // Tampilkan tabel GDP mentah di bawah grafik (debug)
                    const ctx = document.getElementById('actualVsGDPChart');
                    if (ctx) {
                        const prev = ctx.parentElement.querySelector('.gdp-raw-table');
                        if (prev) prev.remove();
                        ctx.parentElement.insertAdjacentHTML('beforeend', `
                            <div class="gdp-raw-table mt-3">
                                <h6 class="text-secondary">Preview Data GDP dari Backend:</h6>
                                <div style="max-height:180px;overflow:auto;">
                                    <table class="table table-sm table-bordered bg-white">
                                        <thead>
                                            <tr>
                                                <th>Tahun</th>
                                                <th>GDP (M USD)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.gdp.length > 0 ? data.gdp.map(row => `
                                                <tr>
                                                    <td>${row.year}</td>
                                                    <td>${row.value}</td>
                                                </tr>
                                            `).join('') : `<tr><td colspan="2" class="text-muted">Data GDP kosong</td></tr>`}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `);
                    }
                } else {
                    // Tampilkan pesan jika data tidak lengkap
                    const ctx = document.getElementById('actualVsGDPChart');
                    if (ctx) {
                        ctx.parentElement.innerHTML = `
                            <div class="text-center text-warning py-2">
                                <small>
                                    Data asli atau GDP dari backend tidak tersedia atau format salah.<br>
                                    <b>Isi data.gdp:</b> <code>${JSON.stringify(data && data.gdp)}</code><br>
                                    <b>Isi data.actual:</b> <code>${JSON.stringify(data && data.actual)}</code>
                                </small>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                const ctx = document.getElementById('actualVsGDPChart');
                if (ctx) {
                    // Pesan khusus jika endpoint tidak ditemukan
                    if (error && error.message === 'ENDPOINT_NOT_FOUND') {
                        ctx.parentElement.innerHTML = `
                            <div class="text-center text-danger py-2">
                                <small>
                                    <b>Gagal mengambil data asli & GDP dari backend.</b><br>
                                    <b>Solusi:</b> Endpoint <code>/api/dashboard/actual-gdp</code> <b>belum ada di backend</b>.<br>
                                    <br>
                                    <b>Contoh response yang diharapkan:</b><br>
                                    <code>
                                    {
                                        "actual": [ { "year": 2015, "value": 44.2 }, ... ],
                                        "gdp": [ { "year": 2015, "value": 900 }, ... ]
                                    }
                                    </code>
                                </small>
                            </div>
                        `;
                    } else {
                        // Error selain endpoint tidak ditemukan
                        ctx.parentElement.innerHTML = `
                            <div class="text-center text-danger py-2">
                                <small>
                                    Terjadi error saat mengambil data dari backend.<br>
                                    <code>${error}</code>
                                </small>
                            </div>
                        `;
                    }
                }
            });
    }

    //fungsi grafik data energy
    function createEnergyChart(actualData) {
        const ctx = document.getElementById('energyChart');
        if (!ctx) return;

        if (charts.energyChart) {
            charts.energyChart.destroy();
        }

        charts.energyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: actualData.map(d => d.year),
                datasets: [{
                    label: 'Konsumsi Energi (TWh)',
                    data: actualData.map(d => d.value),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    //fungsi grafik data GDP
    function createGDPChart(gdpData) {
        const ctx = document.getElementById('gdpChart');
        if (!ctx) return;

        if (charts.gdpChart) {
            charts.gdpChart.destroy();
        }

        charts.gdpChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: gdpData.map(d => d.year),
                datasets: [{
                    label: 'GDP (M USD)',
                    data: gdpData.map(d => d.value),
                    borderColor: 'rgb(255, 206, 86)',
                    backgroundColor: 'rgba(255, 206, 86, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    function interpretMAPE(mape) {
        if (mape < 10) {
            return { text: "Sangat Baik (Model sangat akurat)", color: "text-success", bar: "bg-success" };
        } else if (mape < 20) {
            return { text: "Baik (Akurasi model baik)", color: "text-primary", bar: "bg-primary" };
        } else if (mape < 50) {
            return { text: "Cukup (Model masih bisa ditingkatkan)", color: "text-warning", bar: "bg-warning" };
        } else {
            return { text: "Buruk (Model kurang akurat)", color: "text-danger", bar: "bg-danger" };
        }
    }


    // Load model info (API real - untuk nanti)
    function loadModelInfo() {
        fetch('/api/dashboard/model-info')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('modelVersion').textContent = data.model_version || 'ARIMAX (?,?,?)';
                    document.getElementById('modelAccuracy').textContent = `MAPE: ${data.mape ? data.mape.toFixed(2) + '%' : '-'}`;

                    // Update R² Score card
                    if (data.r2 !== null && data.r2 !== undefined) {
                        document.getElementById('r2Score').textContent = data.r2.toFixed(4);
                        const r2Percent = (data.r2 * 100).toFixed(1);
                        document.getElementById('r2Label').textContent = `${r2Percent}% variance explained`;
                    }

                    // Performance metrics
                    document.getElementById('mapeValue').textContent = data.mape ? data.mape.toFixed(2) + '%' : '-';
                    document.getElementById('r2Value').textContent = data.r2 ? data.r2.toFixed(4) : '-';
                    document.getElementById('rmseValue').textContent = data.rmse ? data.rmse.toFixed(4) : '-';
                    document.getElementById('maeValue').textContent = data.mae ? data.mae.toFixed(4) : '-';

                    // Progress bars (invert for MAPE - lower is better)
                    if (data.mape !== null && data.mape !== undefined) {

                        const mape = data.mape;

                        // Set nilai MAPE
                        document.getElementById('mapeValue').textContent = mape.toFixed(2) + '%';

                        // Interpretasi
                        const interpretation = interpretMAPE(mape);

                        const descEl = document.getElementById('mapeDescription');
                        if (descEl) {
                            descEl.textContent = interpretation.text;
                            descEl.className = "fw-bold " + interpretation.color;
                        }

                        // Progress bar (dibalik karena makin kecil makin bagus)
                        const mapeScore = Math.max(0, 100 - mape);
                        const mapeBar = document.getElementById('mapeBar');
                        mapeBar.style.width = mapeScore + '%';

                        // Ganti warna progress bar sesuai kualitas
                        mapeBar.className = "progress-bar " + interpretation.bar;
                    }

                    if (data.r2) {
                        document.getElementById('r2Bar').style.width = (data.r2 * 100) + '%';
                    }

                    // Last training info
                    document.getElementById('lastTrainingDate').textContent = data.lastTrained || '-';
                    document.getElementById('modelParams').textContent = data.params || '-';
                    document.getElementById('trainingDuration').textContent = data.duration || '-';

                    // Load comparison chart
                    if (data.testData) {
                        createComparisonChart(data.testData);
                        createMiniComparisonChart(data.testData); // Tambahan: grafik mini
                    } else {
                        // Show placeholder for comparison chart
                        const comparisonCanvas = document.getElementById('comparisonChart');
                        if (comparisonCanvas) {
                            const container = comparisonCanvas.parentElement;
                            container.innerHTML = `
                                <div class="text-center py-5">
                                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Data perbandingan belum tersedia</p>
                                    <small class="text-muted">Lakukan retrain model untuk melihat chart ini</small>
                                    <br>
                                    <a href="/admin/update-model" class="btn btn-sm btn-primary mt-3">
                                        <i class="fas fa-brain me-1"></i> Retrain Model
                                    </a>
                                </div>
                            `;
                        }
                    }

                    // Load error distribution chart
                    if (data.errorData) {
                        createErrorChart(data.errorData);
                    } else {
                        // Show placeholder for error chart
                        const errorCanvas = document.getElementById('errorChart');
                        if (errorCanvas) {
                            const container = errorCanvas.parentElement;
                            container.innerHTML = `
                                <div class="text-center py-5">
                                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Data distribusi error belum tersedia</p>
                                    <small class="text-muted">Lakukan retrain model untuk melihat chart ini</small>
                                    <br>
                                    <a href="/admin/update-model" class="btn btn-sm btn-primary mt-3">
                                        <i class="fas fa-brain me-1"></i> Retrain Model
                                    </a>
                                </div>
                            `;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading model info:', error);
            });
    }

    //range data
    fetch("/api/data/range")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("totalRecords").innerText = data.total_records;
                document.getElementById("yearRange").innerText =
                    `records (${data.min_year}-${data.max_year})`;
            }
        })
        .catch(error => console.error("Error:", error));

    // Load prediction data
    function loadPredictionData() {
        fetch('/api/dashboard/prediction')
            .then(response => response.json())
            .then(data => {
                // Update total records and data range even if prediction fails
                if (data.total_records !== undefined) {
                    const range = data.data_range ? `(${data.data_range.start}-${data.data_range.end})` : '';
                    document.getElementById('totalRecords').textContent = data.total_records;
                    document.querySelector('#totalRecords').parentElement.querySelector('small').textContent = `records ${range}`;
                }

                if (data.success) {
                    // Debug: Log data struktur
                    console.log('Prediction Data:', data);
                    console.log('Historical sample:', data.historical.slice(-3));
                    console.log('Predictions sample:', data.predictions.slice(0, 3));

                    // Update trend
                    if (data.trend !== undefined) {
                        const trendIcon = data.trend > 0 ?
                            '<i class="fas fa-arrow-up text-danger"></i>' :
                            '<i class="fas fa-arrow-down text-success"></i>';
                        document.getElementById('trendIndicator').innerHTML = trendIcon +
                            ' <span id="trendValue">' + Math.abs(data.trend).toFixed(2) + ' TWh/tahun</span>';
                    }

                    // Create main prediction chart
                    createPredictionChart(data);

                    // Populate prediction table with historical data for comparison
                    populatePredictionTable(data.predictions, data.historical);
                } else {
                    console.warn('Prediction error:', data.error);
                    // Show empty chart message with action button
                    const chartContainer = document.getElementById('predictionChart');
                    if (chartContainer) {
                        const canvas = chartContainer.parentElement;
                        canvas.innerHTML = `
                            <div class="alert alert-warning text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <p class="mb-2">Prediksi belum tersedia. ${data.error || 'Model belum di-training.'}</p>
                                <a href="/admin/scraping-data" class="btn btn-sm btn-success me-2">
                                    <i class="fas fa-download me-1"></i> Update Data
                                </a>
                                <a href="/admin/update-model" class="btn btn-sm btn-primary">
                                    <i class="fas fa-brain me-1"></i> Training Model
                                </a>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading prediction data:', error);
            });
    }

    // Create main prediction chart
    function createPredictionChart(data) {
        const ctx = document.getElementById('predictionChart');
        if (!ctx) return;

        console.log('Creating prediction chart with data:', {
            historicalCount: data.historical?.length,
            predictionsCount: data.predictions?.length,
            firstHistorical: data.historical?.[0],
            lastHistorical: data.historical?.[data.historical?.length - 1],
            firstPrediction: data.predictions?.[0],
            lastPrediction: data.predictions?.[data.predictions?.length - 1]
        });

        // Destroy existing chart
        if (charts.prediction) {
            charts.prediction.destroy();
        }

        // Map data with explicit year values
        const historicalData = data.historical.map(d => ({ x: d.year, y: d.value }));
        const predictionData = data.predictions.map(d => ({ x: d.year, y: d.value }));

        // Debug: Log mapped data
        console.log('Mapped historical data (first 3):', historicalData.slice(0, 3));
        console.log('Mapped historical data (last 3):', historicalData.slice(-3));
        console.log('Mapped prediction data:', predictionData);

        const datasets = [
            {
                label: 'Data Aktual',
                data: historicalData,
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                fill: false
            },
            {
                label: 'Prediksi',
                data: predictionData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false
            }
        ];

        // Add confidence interval
        if (data.predictions[0]?.lowerBound !== undefined && data.predictions[0]?.lowerBound !== null) {
            datasets.push({
                label: 'Upper Bound (95%)',
                data: data.predictions.map(d => ({ x: d.year, y: d.upperBound })),
                borderColor: 'rgba(150, 150, 255, 0.4)',
                backgroundColor: 'rgba(150, 150, 255, 0.15)',
                borderWidth: 1,
                borderDash: [3, 3],
                pointRadius: 0,
                fill: '+1'   // ← fill ke bawah ke arah Lower Bound
            });

            datasets.push({
                label: 'Lower Bound (95%)',
                data: data.predictions.map(d => ({ x: d.year, y: d.lowerBound })),
                borderColor: 'rgba(150, 150, 255, 0.4)',
                backgroundColor: 'rgba(150, 150, 255, 0.15)',
                borderWidth: 1,
                borderDash: [3, 3],
                pointRadius: 0,
                fill: false
            });
        }

        charts.prediction = new Chart(ctx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'nearest',
                        intersect: false,
                        callbacks: {
                            title: function (context) {
                                // Get year from the actual hovered dataset
                                if (context && context.length > 0) {
                                    const datasetIndex = context[0].datasetIndex;
                                    const dataIndex = context[0].dataIndex;
                                    const dataPoint = context[0].chart.data.datasets[datasetIndex].data[dataIndex];

                                    if (dataPoint && typeof dataPoint === 'object' && dataPoint.x) {
                                        return 'Tahun ' + Math.round(dataPoint.x);
                                    }
                                }

                                // Fallback
                                return 'Tahun ' + Math.round(context[0].parsed.x);
                            },
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + ' TWh';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        min: Math.min(...historicalData.map(d => d.x)),
                        max: Math.max(...predictionData.map(d => d.x)),
                        title: {
                            display: true,
                            text: 'Tahun'
                        },
                        ticks: {
                            stepSize: 5,
                            callback: function (value) {
                                // Display year as integer without formatting
                                return Math.round(value);
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Konsumsi Energi Fosil (%)'
                        },
                        ticks: {
                            callback: function (value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Create comparison chart (Actual vs Predicted)
    function createComparisonChart(testData) {
        const ctx = document.getElementById('comparisonChart');
        if (!ctx) return;

        if (charts.comparison) {
            charts.comparison.destroy();
        }

        charts.comparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: testData.years,
                datasets: [
                    {
                        label: 'Actual',
                        data: testData.actual,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    },
                    {
                        label: 'Predicted',
                        data: testData.predicted,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function (value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Create error distribution chart
    function createErrorChart(errorData) {
        const ctx = document.getElementById('errorChart');
        if (!ctx) return;

        if (charts.error) {
            charts.error.destroy();
        }

        charts.error = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: errorData.bins,
                datasets: [{
                    label: 'Frekuensi Error',
                    data: errorData.frequencies,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Distribusi Error Prediksi (%)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Frekuensi'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Error Range (%)'
                        }
                    }
                }
            }
        });
    }

    // Populate prediction table
    function populatePredictionTable(predictions, historical) {
        const tbody = document.getElementById('predictionTableBody');
        if (!predictions || predictions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Tidak ada data prediksi</td></tr>';
            return;
        }

        // Get last historical value (2024) for comparison with 2025
        const lastHistorical = historical && historical.length > 0 ?
            historical[historical.length - 1].value : null;

        tbody.innerHTML = predictions.map((pred, index) => {
            let change = 0;
            let previousValue = null;

            if (index === 0 && lastHistorical !== null) {
                previousValue = lastHistorical;
                change = pred.value - lastHistorical;
            } else if (index > 0) {
                previousValue = predictions[index - 1].value;
                change = pred.value - previousValue;
            }

            const changePercent = previousValue ? ((change / previousValue) * 100) : 0;
            const changeClass = change > 0 ? 'text-danger' : change < 0 ? 'text-success' : 'text-secondary';
            const changeIcon = change > 0 ? 'fa-arrow-up' : change < 0 ? 'fa-arrow-down' : 'fa-minus';

            // Status berdasarkan persentase perubahan
            const statusClass = changePercent > 5 ? 'bg-danger' : changePercent > 3 ? 'bg-warning' : 'bg-success';
            const statusText = changePercent > 5 ? 'Naik Tinggi' : changePercent > 3 ? 'Naik Sedang' : 'Naik Rendah';

            return `
        <tr>
            <td><strong>${pred.year}</strong></td>
            <td><strong>${pred.value.toFixed(2)} TWh</strong></td>
            <td>${pred.lowerBound !== undefined ? pred.lowerBound.toFixed(2) + ' TWh' : '-'}</td>
            <td>${pred.upperBound !== undefined ? pred.upperBound.toFixed(2) + ' TWh' : '-'}</td>
            <td class="${changeClass}">
                <i class="fas ${changeIcon} me-1"></i>
                ${Math.abs(change).toFixed(2)} TWh (${Math.abs(changePercent).toFixed(2)}%)
            </td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
        </tr>
    `;
        }).join('');
    }

    // Load recent activities
    function loadRecentActivities() {
        fetch('/api/dashboard/recent-activities')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.activities && data.activities.length > 0) {
                    renderActivities(data.activities);
                } else {
                    document.getElementById('recentActivities').innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>Belum ada aktivitas terbaru</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading activities:', error);
            });
    }

    // Render activities timeline
    function renderActivities(activities) {
        const container = document.getElementById('recentActivities');
        container.innerHTML = activities.slice(0, 5).map(activity => {
            const iconMap = {
                'training': { icon: 'fa-brain', color: 'primary' },
                'data': { icon: 'fa-database', color: 'success' },
                'prediction': { icon: 'fa-chart-line', color: 'info' }
            };
            const config = iconMap[activity.type] || iconMap['data'];

            return `
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-${config.color} bg-opacity-10 p-2 rounded-circle" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${config.icon} text-${config.color}"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${activity.title}</h6>
                            <small class="text-muted">${formatTimeAgo(activity.timestamp)}</small>
                        </div>
                        <p class="text-muted small mb-0">${activity.description}</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Format time ago
    function formatTimeAgo(timestamp) {
        try {
            const now = new Date();
            const then = new Date(timestamp);

            // Check if date is valid
            if (isNaN(then.getTime())) {
                return 'Baru saja';
            }

            const diff = Math.floor((now - then) / 1000); // seconds

            if (diff < 0) return 'Baru saja'; // Handle future dates
            if (diff < 60) return 'Baru saja';
            if (diff < 3600) {
                const mins = Math.floor(diff / 60);
                return mins + ' menit lalu';
            }
            if (diff < 86400) {
                const hours = Math.floor(diff / 3600);
                return hours + ' jam lalu';
            }
            if (diff < 604800) { // Less than a week
                const days = Math.floor(diff / 86400);
                return days + ' hari lalu';
            }

            // For older dates, show the actual date
            return then.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        } catch (e) {
            console.error('Error formatting timestamp:', timestamp, e);
            return 'Baru saja';
        }
    }

    // Load system status
    function loadSystemStatus() {
        fetch('/api/dashboard/system-status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update Model Server status
                    const modelBadge = data.modelServerRunning ?
                        '<i class="fas fa-check-circle"></i> Running' :
                        '<i class="fas fa-times-circle"></i> Stopped';
                    const modelClass = data.modelServerRunning ? 'bg-success' : 'bg-danger';

                    document.getElementById('modelServerStatus').className = 'badge ' + modelClass;
                    document.getElementById('modelServerStatus').innerHTML = modelBadge;

                    // Update Database status
                    const dbBadge = data.databaseConnected ?
                        '<i class="fas fa-check-circle"></i> Online' :
                        '<i class="fas fa-times-circle"></i> Offline';
                    const dbClass = data.databaseConnected ? 'bg-success' : 'bg-danger';

                    document.getElementById('databaseStatus').className = 'badge ' + dbClass;
                    document.getElementById('databaseStatus').innerHTML = dbBadge;
                }
            })
            .catch(error => {
                console.error('Error loading system status:', error);
                // On error, set offline status
                document.getElementById('databaseStatus').className = 'badge bg-danger';
                document.getElementById('databaseStatus').innerHTML = '<i class="fas fa-times-circle"></i> Offline';
                document.getElementById('modelServerStatus').className = 'badge bg-danger';
                document.getElementById('modelServerStatus').innerHTML = '<i class="fas fa-times-circle"></i> Stopped';
            });
    }

    // Generate report
    function generateReport() {
        showToast('Generating report...', 'info');

        fetch('/api/dashboard/generate-report', {
            method: 'POST'
        })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `FossilTrack_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Report berhasil diunduh!', 'success');
            })
            .catch(error => {
                console.error('Error generating report:', error);
                showToast('Gagal generate report', 'error');
            });
    }

    // Show toast notification
    function showToast(message, type) {
        const toastEl = document.getElementById('notificationToast');
        const toast = new bootstrap.Toast(toastEl);
        const toastMessage = document.getElementById('toastMessage');

        const icons = {
            'success': '<i class="fas fa-check-circle text-success me-2"></i>',
            'error': '<i class="fas fa-exclamation-circle text-danger me-2"></i>',
            'info': '<i class="fas fa-info-circle text-info me-2"></i>'
        };
        toastMessage.innerHTML = (icons[type] || '') + message;

        toast.show();
    }

    // Tambahkan fungsi untuk membuat grafik mini comparison (test set)
    function createMiniComparisonChart(testData) {
        const ctx = document.getElementById('miniComparisonChart');
        if (!ctx) return;

        if (charts.miniComparison) {
            charts.miniComparison.destroy();
        }

        charts.miniComparison = new Chart(ctx, {
            type: 'line',
            data: {
                labels: testData.years,
                datasets: [
                    {
                        label: 'Actual',
                        data: testData.actual,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'Predicted',
                        data: testData.predicted,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        borderDash: [4, 2],
                        pointRadius: 2,
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
    }

    // Panggil grafik baru di loadDashboardData
    function loadDashboardData() {
        loadModelInfo();
        loadPredictionData();
        loadRecentActivities();
        loadSystemStatus();
        loadActualAndGDPData(); // <-- panggil API untuk grafik Data Asli vs GDP
    }

    // Fungsi membuat grafik data asli vs GDP
    function createActualVsGDPChart(actualData, gdpData) {
        const ctx = document.getElementById('actualVsGDPChart');
        if (!ctx) return;

        if (charts.actualVsGDP) {
            charts.actualVsGDP.destroy();
        }

        // Map tahun dan nilai
        const years = actualData.map(d => d.year);
        const actualValues = actualData.map(d => d.value);
        // Perbaikan: handle jika gdpData kosong, tetap tampilkan grafik energi
        const gdpValues = Array.isArray(gdpData) && gdpData.length > 0
            ? years.map(y => {
                const found = gdpData.find(g => g.year === y);
                return found ? found.value : null;
            })
            : years.map(() => null);

        charts.actualVsGDP = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [
                    {
                        label: 'Data Asli (Energi)',
                        data: actualValues,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: false,
                        yAxisID: 'y'
                    },
                    {
                        label: 'GDP',
                        data: gdpValues,
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: false,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { enabled: true }
                },
                scales: {
                    y: {
                        title: { display: true, text: 'Energi (TWh)' },
                        position: 'left'
                    },
                    y1: {
                        title: { display: true, text: 'GDP (M USD)' },
                        position: 'right',
                        grid: { drawOnChartArea: false }
                    },
                    x: {
                        title: { display: true, text: 'Tahun' }
                    }
                }
            }
        });

        // Pesan hanya jika data GDP benar-benar kosong/null
        if (!Array.isArray(gdpData) || gdpData.length === 0) {
            ctx.parentElement.insertAdjacentHTML('beforeend', `
                <div class="text-center text-warning py-2">
                    <small>Data GDP tidak tersedia dari backend.</small>
                </div>
            `);
        }
    }

</script>

<style>
    .section-dashboard .card {
        border: none;
        transition: all 0.3s ease;
    }

    .section-dashboard .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .border-4 {
        border-width: 4px !important;
    }

    .timeline {
        max-height: 400px;
        overflow-y: auto;
    }

    .table-responsive {
        max-height: 400px;
    }

    code {
        background-color: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.85em;
    }

    .toast {
        min-width: 300px;
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
    }

    #predictionChartContainer canvas {
        max-height: 400px;
    }
</style>

{% endblock %}