{% extends 'admin/layouts/template.html' %}

{% block title %}Riwayat Aktivitas - Admin{% endblock %}

{% block content %}
<div class="section-history container-fluid mt-3 mb-5">
    <div class="mt-1 row g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Total Training</p>
                            <h4 class="fw-bold mb-0" id="totalTraining">0</h4>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-brain text-primary fs-4"></i>
                        </div>
                    </div>
                    <small class="text-muted">Model retraining</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Update Data</p>
                            <h4 class="fw-bold mb-0" id="totalDataUpdate">0</h4>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                            <i class="fas fa-database text-success fs-4"></i>
                        </div>
                    </div>
                    <small class="text-muted">Data fetch & upload</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-start border-info border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Prediksi</p>
                            <h4 class="fw-bold mb-0" id="totalPrediction">0</h4>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded">
                            <i class="fas fa-chart-line text-info fs-4"></i>
                        </div>
                    </div>
                    <small class="text-muted">Forecast dibuat</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Hari Ini</p>
                            <h4 class="fw-bold mb-0" id="todayActivities">0</h4>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                            <i class="fas fa-calendar-day text-warning fs-4"></i>
                        </div>
                    </div>
                    <small class="text-muted">Aktivitas hari ini</small>
                </div>
            </div>
        </div>
    </div>

    <!-- History Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="historyTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="training-tab" data-bs-toggle="tab"
                                data-bs-target="#training" type="button" role="tab">
                                <i class="fas fa-brain me-2"></i>Riwayat Training Model
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data"
                                type="button" role="tab">
                                <i class="fas fa-database me-2"></i>Riwayat Update Data
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="prediction-tab" data-bs-toggle="tab"
                                data-bs-target="#prediction" type="button" role="tab">
                                <i class="fas fa-chart-line me-2"></i>Riwayat Prediksi
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <!-- Filter Section -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold small">Filter Tanggal</label>
                            <select class="form-select form-select-sm" id="dateFilter">
                                <option value="all">Semua Waktu</option>
                                <option value="today">Hari Ini</option>
                                <option value="week">7 Hari Terakhir</option>
                                <option value="month" selected>30 Hari Terakhir</option>
                                <option value="year">1 Tahun Terakhir</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small">Status</label>
                            <select class="form-select form-select-sm" id="statusFilter">
                                <option value="all">Semua Status</option>
                                <option value="success">Berhasil</option>
                                <option value="failed">Gagal</option>
                                <option value="running">Sedang Berjalan</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small">Cari</label>
                            <input type="text" class="form-control form-control-sm" id="searchInput"
                                placeholder="Cari berdasarkan keterangan...">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-sm btn-primary w-100" id="btnApplyFilter">
                                <i class="fas fa-filter me-1"></i>Terapkan
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content" id="historyTabContent">
                        <!-- Training History Tab -->
                        <div class="tab-pane fade show active" id="training" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 5%;">No</th>
                                            <th style="width: 15%;">Tanggal & Waktu</th>
                                            <th style="width: 12%;">Model Version</th>
                                            <th style="width: 15%;">Parameters (p,d,q)</th>
                                            <th style="width: 12%;">Akurasi (MAPE)</th>
                                            <th style="width: 10%;">Status</th>
                                            <th style="width: 20%;">Keterangan</th>
                                            <th style="width: 11%;">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trainingTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                                <p>Belum ada riwayat training model</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination -->
                            <nav id="trainingPagination" style="display: none;">
                                <ul class="pagination justify-content-center">
                                    <!-- Pagination items will be inserted here -->
                                </ul>
                            </nav>
                        </div>

                        <!-- Data Update History Tab -->
                        <div class="tab-pane fade" id="data" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 5%;">No</th>
                                            <th style="width: 15%;">Tanggal & Waktu</th>
                                            <th style="width: 12%;">Metode</th>
                                            <th style="width: 15%;">Jenis Data</th>
                                            <th style="width: 12%;">Records Ditambah</th>
                                            <th style="width: 10%;">Status</th>
                                            <th style="width: 20%;">Keterangan</th>
                                            <th style="width: 11%;">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dataTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                                <p>Belum ada riwayat update data</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination -->
                            <nav id="dataPagination" style="display: none;">
                                <ul class="pagination justify-content-center">
                                    <!-- Pagination items will be inserted here -->
                                </ul>
                            </nav>
                        </div>

                        <!-- Prediction History Tab -->
                        <div class="tab-pane fade" id="prediction" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 5%;">No</th>
                                            <th style="width: 15%;">Tanggal & Waktu</th>
                                            <th style="width: 12%;">Model Used</th>
                                            <th style="width: 15%;">Forecast Period</th>
                                            <th style="width: 12%;">Skenario</th>
                                            <th style="width: 10%;">Status</th>
                                            <th style="width: 20%;">User/Admin</th>
                                            <th style="width: 11%;">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="predictionTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                                <p>Belum ada riwayat prediksi</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination -->
                            <nav id="predictionPagination" style="display: none;">
                                <ul class="pagination justify-content-center">
                                    <!-- Pagination items will be inserted here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalTitle">Detail Aktivitas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailModalBody">
                <!-- Detail content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Konfirmasi Hapus</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Apakah Anda yakin ingin menghapus riwayat ini?</p>
                <p class="text-danger"><strong>Perhatian:</strong> Tindakan ini tidak dapat dibatalkan.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">Hapus</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notificationToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-bell me-2"></i>
            <strong class="me-auto">Notifikasi</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Pesan notifikasi
        </div>
    </div>
</div>

<script>
    // Global variables for filtering
    let allTrainingData = [];
    let allDataUpdateData = [];
    let allPredictionData = [];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadSummary();
        loadTrainingHistory();

        // Tab change listeners
        document.getElementById('training-tab').addEventListener('click', loadTrainingHistory);
        document.getElementById('data-tab').addEventListener('click', loadDataHistory);
        document.getElementById('prediction-tab').addEventListener('click', loadPredictionHistory);

        // Filter button
        document.getElementById('btnApplyFilter').addEventListener('click', applyFilters);

        // Real-time search
        document.getElementById('searchInput').addEventListener('input', applyFilters);
    });

    // Apply filters
    function applyFilters() {
        const dateFilter = document.getElementById('dateFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const searchText = document.getElementById('searchInput').value.toLowerCase();

        // Get active tab
        const activeTab = document.querySelector('#historyTabs .nav-link.active');
        if (!activeTab) return;

        const tabId = activeTab.id;

        let filteredData = [];

        if (tabId === 'training-tab') {
            filteredData = filterData(allTrainingData, dateFilter, statusFilter, searchText, 'training');
            if (filteredData.length > 0) {
                renderTrainingTable(filteredData);
            } else {
                document.getElementById('trainingTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-filter fa-2x mb-3 d-block"></i>
                            <p>Tidak ada data yang sesuai dengan filter</p>
                        </td>
                    </tr>
                `;
            }
        } else if (tabId === 'data-tab') {
            filteredData = filterData(allDataUpdateData, dateFilter, statusFilter, searchText, 'data');
            if (filteredData.length > 0) {
                renderDataTable(filteredData);
            } else {
                document.getElementById('dataTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-filter fa-2x mb-3 d-block"></i>
                            <p>Tidak ada data yang sesuai dengan filter</p>
                        </td>
                    </tr>
                `;
            }
        } else if (tabId === 'prediction-tab') {
            filteredData = filterData(allPredictionData, dateFilter, statusFilter, searchText, 'prediction');
            if (filteredData.length > 0) {
                renderPredictionTable(filteredData);
            } else {
                document.getElementById('predictionTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-filter fa-2x mb-3 d-block"></i>
                            <p>Tidak ada data yang sesuai dengan filter</p>
                        </td>
                    </tr>
                `;
            }
        }

        console.log(`Filter applied: ${filteredData.length} items found`);
    }

    // Filter data based on criteria
    function filterData(data, dateFilter, statusFilter, searchText, type) {
        console.log(`Filtering ${type} data:`, {
            totalItems: data.length,
            dateFilter,
            statusFilter,
            searchText
        });

        const filtered = data.filter(item => {
            // Date filter
            if (dateFilter !== 'all') {
                const itemDate = new Date(item.training_date || item.update_date || item.prediction_date);
                const now = new Date();
                const daysDiff = Math.floor((now - itemDate) / (1000 * 60 * 60 * 24));

                if (dateFilter === 'today' && daysDiff > 0) return false;
                if (dateFilter === 'week' && daysDiff > 7) return false;
                if (dateFilter === 'month' && daysDiff > 30) return false;
                if (dateFilter === 'year' && daysDiff > 365) return false;
            }

            // Status filter
            if (statusFilter !== 'all') {
                const itemStatus = (item.status || 'success').toLowerCase();
                if (itemStatus !== statusFilter) return false;
            }

            // Search filter
            if (searchText) {
                const searchableText = [
                    item.notes || '',
                    item.message || '',
                    item.model_version || '',
                    item.source || '',
                    item.scenario || '',
                    `${item.p},${item.d},${item.q}`
                ].join(' ').toLowerCase();

                if (!searchableText.includes(searchText)) return false;
            }

            return true;
        });

        console.log(`Filtered result: ${filtered.length} items`);
        return filtered;
    }

    // Load summary statistics
    function loadSummary() {
        fetch('/api/history/summary')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('totalTraining').textContent = stats.total_training || 0;
                    document.getElementById('totalDataUpdate').textContent = stats.total_data_update || 0;
                    document.getElementById('totalPrediction').textContent = stats.total_prediction || 0;
                    document.getElementById('todayActivities').textContent = stats.today_activities || 0;
                }
            })
            .catch(error => {
                console.error('Error loading summary:', error);
            });
    }

    // Load training history
    function loadTrainingHistory() {
        fetch('/api/history/training')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    allTrainingData = data.data; // Store for filtering
                    applyFilters(); // Apply current filters
                } else {
                    allTrainingData = [];
                    document.getElementById('trainingTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                <p>Belum ada riwayat training model</p>
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading training history:', error);
            });
    }

    // Render training table
    function renderTrainingTable(items) {
        const tbody = document.getElementById('trainingTableBody');
        tbody.innerHTML = items.map((item, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${item.training_date || '-'}</td>
                <td><span class="badge bg-primary">${item.model_version || 'v1.0'}</span></td>
                <td><code>ARIMAX(${item.p || 0}, ${item.d || 0}, ${item.q || 0})</code></td>
                <td><strong class="${item.mape < 10 ? 'text-success' : item.mape < 20 ? 'text-warning' : 'text-danger'}">${item.mape ? item.mape.toFixed(2) + '%' : '-'}</strong></td>
                <td><span class="badge bg-success">Success</span></td>
                <td><small>${item.year_range || '-'} (${item.total_data || 0} data)</small></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="viewTrainingDetail(${item.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Load data update history
    function loadDataHistory() {
        fetch('/api/history/data-update')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    allDataUpdateData = data.data; // Store for filtering
                    applyFilters(); // Apply current filters
                } else {
                    allDataUpdateData = [];
                    document.getElementById('dataTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                <p>Belum ada riwayat update data</p>
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading data history:', error);
            });
    }

    // Render data update table
    function renderDataTable(items) {
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = items.map((item, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${item.update_date || '-'}</td>
                <td>
                    <span class="badge ${item.update_type === 'fetch_api' ? 'bg-primary' : 'bg-success'}">
                        <i class="fas fa-${item.update_type === 'fetch_api' ? 'cloud' : 'upload'} me-1"></i>
                        ${item.update_type === 'fetch_api' ? 'API Fetch' : 'Manual Upload'}
                    </span>
                </td>
                <td>${item.source || 'All'}</td>
                <td><strong>${item.records_added || 0}</strong> records</td>
                <td><span class="badge bg-${item.status === 'success' ? 'success' : 'danger'}">${item.status || 'success'}</span></td>
                <td><small>${item.message || '-'}</small></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="viewDataDetail(${item.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Load prediction history
    function loadPredictionHistory() {
        fetch('/api/history/prediction')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    allPredictionData = data.data; // Store for filtering
                    applyFilters(); // Apply current filters
                } else {
                    allPredictionData = [];
                    document.getElementById('predictionTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                <p>Belum ada riwayat prediksi</p>
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading prediction history:', error);
            });
    }

    // Render prediction table
    function renderPredictionTable(items) {
        const tbody = document.getElementById('predictionTableBody');
        tbody.innerHTML = items.map((item, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${item.prediction_date || '-'}</td>
                <td><span class="badge bg-primary">${item.model_version || 'ARIMAX v1.0'}</span></td>
                <td><strong>${item.years || 0} tahun</strong></td>
                <td>
                    <span class="badge bg-${item.scenario === 'optimis' ? 'success' : item.scenario === 'moderat' ? 'warning' : 'danger'}">
                        ${item.scenario || 'moderat'}
                    </span>
                </td>
                <td><span class="badge bg-success">Success</span></td>
                <td>User/Admin</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="viewPredictionDetail(${item.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // View detail functions (modal)
    function viewTrainingDetail(id) {
        // Fetch detail from API
        fetch(`/api/training-history/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    const modalBody = document.getElementById('detailModalBody');
                    
                    // Build detail HTML with preprocessing visualizations
                    let visualizationHtml = '';
                    
                    if (data.acf_plot || data.pacf_plot || data.preprocessing_plot || data.train_test_plot) {
                        visualizationHtml = `
                            <h6 class="mt-4 mb-3 fw-bold text-primary">
                                <i class="fas fa-chart-bar me-2"></i>Visualisasi Preprocessing Data
                            </h6>
                            <div class="row g-3">
                                ${data.acf_plot ? `
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title fw-bold">ACF Plot (Autocorrelation Function)</h6>
                                                <p class="text-muted small">Menunjukkan korelasi data dengan lag sebelumnya untuk identifikasi order MA (q)</p>
                                                <img src="${data.acf_plot}" class="img-fluid rounded" alt="ACF Plot">
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${data.pacf_plot ? `
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title fw-bold">PACF Plot (Partial Autocorrelation Function)</h6>
                                                <p class="text-muted small">Menunjukkan korelasi parsial untuk identifikasi order AR (p)</p>
                                                <img src="${data.pacf_plot}" class="img-fluid rounded" alt="PACF Plot">
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${data.preprocessing_plot ? `
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title fw-bold">Data Preprocessing: Train-Test Split</h6>
                                                <p class="text-muted small">Pembagian data training (hijau) dan testing (orange) untuk evaluasi model</p>
                                                <img src="${data.preprocessing_plot}" class="img-fluid rounded" alt="Preprocessing Plot">
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${data.train_test_plot ? `
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title fw-bold">Training vs Testing Data</h6>
                                                <p class="text-muted small">Perbandingan data point training dan testing yang digunakan</p>
                                                <img src="${data.train_test_plot}" class="img-fluid rounded" alt="Train Test Plot">
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    modalBody.innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 class="text-muted">ID Training</h6>
                                <p class="fw-bold">#${data.id}</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Tanggal Training</h6>
                                <p class="fw-bold">${new Date(data.training_date).toLocaleString('id-ID')}</p>
                            </div>
                        </div>
                        
                        <!-- PREPROCESSING STEPS TIMELINE -->
                        ${data.preprocessing_steps && data.preprocessing_steps.length > 0 ? `
                        <div class="alert alert-primary mb-4">
                            <i class="fas fa-timeline me-2"></i><strong>Tahapan Preprocessing Data</strong>
                        </div>
                        <div class="accordion" id="preprocessingAccordion">
                            ${data.preprocessing_steps.map(step => `
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading${step.step}">
                                        <button class="accordion-button ${step.step === 1 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${step.step}" aria-expanded="${step.step === 1 ? 'true' : 'false'}">
                                            <span class="badge ${step.status === 'success' ? 'bg-success' : step.status === 'warning' ? 'bg-warning' : 'bg-danger'} me-3">${step.step}</span>
                                            <strong>${step.title}</strong>
                                        </button>
                                    </h2>
                                    <div id="collapse${step.step}" class="accordion-collapse collapse ${step.step === 1 ? 'show' : ''}" data-bs-parent="#preprocessingAccordion">
                                        <div class="accordion-body">
                                            <p class="text-muted mb-3">${step.description}</p>
                                            <ul class="list-unstyled">
                                                ${step.details.map(detail => `<li><i class="fas fa-check-circle text-success me-2"></i>${detail}</li>`).join('')}
                                            </ul>
                                            
                                            <!-- STEP 4: Train-Test Split Visualization -->
                                            ${step.step === 4 && (data.preprocessing_plot || data.train_test_plot) ? `
                                                <div class="mt-3">
                                                    <h6 class="fw-bold text-primary mb-3"><i class="fas fa-chart-area me-2"></i>Visualisasi Split Data</h6>
                                                    <div class="row g-3">
                                                        ${data.preprocessing_plot ? `
                                                            <div class="col-12">
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <img src="${data.preprocessing_plot}" class="img-fluid rounded" alt="Train-Test Split">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                        ${data.train_test_plot ? `
                                                            <div class="col-12">
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <img src="${data.train_test_plot}" class="img-fluid rounded" alt="Comparison Chart">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            <!-- STEP 5: ACF & PACF Plots -->
                                            ${step.step === 5 && (data.acf_plot || data.pacf_plot) ? `
                                                <div class="mt-3">
                                                    <h6 class="fw-bold text-primary mb-3"><i class="fas fa-chart-line me-2"></i>Grafik ACF & PACF</h6>
                                                    <div class="row g-3">
                                                        ${data.acf_plot ? `
                                                            <div class="col-md-6">
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title fw-bold">ACF Plot</h6>
                                                                        <p class="text-muted small">Hitung berapa lag yang keluar dari confidence interval (garis biru) → order q</p>
                                                                        <img src="${data.acf_plot}" class="img-fluid rounded" alt="ACF Plot">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                        ${data.pacf_plot ? `
                                                            <div class="col-md-6">
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title fw-bold">PACF Plot</h6>
                                                                        <p class="text-muted small">Hitung berapa lag yang keluar dari confidence interval (garis biru) → order p</p>
                                                                        <img src="${data.pacf_plot}" class="img-fluid rounded" alt="PACF Plot">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            <!-- STEP 9: Residual Diagnostics -->
                                            ${step.step === 9 && (data.residual_plot || data.residual_acf_plot || data.qq_plot) ? `
                                                <div class="mt-3">
                                                    <h6 class="fw-bold text-warning mb-3"><i class="fas fa-microscope me-2"></i>Grafik Diagnosis Residual</h6>
                                                    <div class="row g-3">
                                                        ${data.residual_plot ? `
                                                            <div class="col-12">
                                                                <div class="card border-warning">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title fw-bold">Residual Plot</h6>
                                                                        <p class="text-muted small">Residual harus random tanpa pola (white noise)</p>
                                                                        <img src="${data.residual_plot}" class="img-fluid rounded" alt="Residual Plot">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                        ${data.residual_acf_plot ? `
                                                            <div class="col-md-6">
                                                                <div class="card border-warning">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title fw-bold">ACF Residual</h6>
                                                                        <p class="text-muted small">Semua lag harus dalam confidence interval</p>
                                                                        <img src="${data.residual_acf_plot}" class="img-fluid rounded" alt="ACF Residual">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                        ${data.qq_plot ? `
                                                            <div class="col-md-6">
                                                                <div class="card border-warning">
                                                                    <div class="card-body">
                                                                        <h6 class="card-title fw-bold">Q-Q Plot</h6>
                                                                        <p class="text-muted small">Points harus mengikuti garis diagonal (normalitas)</p>
                                                                        <img src="${data.qq_plot}" class="img-fluid rounded" alt="Q-Q Plot">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <hr class="my-4">
                        ` : ''}
                        
                        <!-- PARAMETER MODEL -->
                        <h6 class="mt-4 mb-3 fw-bold text-primary">
                            <i class="fas fa-cog me-2"></i>Parameter Model & Hasil Evaluasi
                        </h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-1">Order (p,d,q)</h6>
                                        <h4 class="mb-0 text-primary">(${data.p}, ${data.d}, ${data.q})</h4>
                                        <small class="text-muted">AR, Diff, MA</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-1">Data Split</h6>
                                        <h4 class="mb-0 text-success">${data.train_percentage}% / ${data.test_percentage}%</h4>
                                        <small class="text-muted">Train / Test</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-1">Total Data</h6>
                                        <h4 class="mb-0 text-info">${data.total_data} records</h4>
                                        <small class="text-muted">Data Points</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <h6 class="text-muted">MAPE</h6>
                                <p class="fw-bold text-success">${data.mape ? Number(data.mape).toFixed(2) : '0.00'}%</p>
                                <small class="text-muted">Akurasi</small>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">RMSE</h6>
                                <p class="fw-bold">${data.rmse ? Number(data.rmse).toFixed(2) : '0.00'}</p>
                                <small class="text-muted">Root MSE</small>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">MAE</h6>
                                <p class="fw-bold">${data.mae ? Number(data.mae).toFixed(2) : '0.00'}</p>
                                <small class="text-muted">Mean Error</small>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">R²</h6>
                                <p class="fw-bold text-info">${data.r2 ? Number(data.r2).toFixed(4) : '0.0000'}</p>
                                <small class="text-muted">Goodness</small>
                            </div>
                        </div>
                        
                        <!-- VISUALIZATIONS -->
                        ${data.acf_plot || data.pacf_plot || data.preprocessing_plot || data.train_test_plot ? `
                        <h6 class="mt-4 mb-3 fw-bold text-primary">
                            <i class="fas fa-chart-bar me-2"></i>Grafik Visualisasi
                        </h6>
                        <div class="row g-3">
                            ${data.acf_plot ? `
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">ACF Plot</h6>
                                            <img src="${data.acf_plot}" class="img-fluid rounded" alt="ACF Plot">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${data.pacf_plot ? `
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">PACF Plot</h6>
                                            <img src="${data.pacf_plot}" class="img-fluid rounded" alt="PACF Plot">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${data.preprocessing_plot ? `
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">Train-Test Split</h6>
                                            <img src="${data.preprocessing_plot}" class="img-fluid rounded" alt="Preprocessing Plot">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${data.train_test_plot ? `
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold">Comparison Chart</h6>
                                            <img src="${data.train_test_plot}" class="img-fluid rounded" alt="Train Test Plot">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${data.residual_plot ? `
                                <div class="col-12">
                                    <div class="card border-warning">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold text-warning">
                                                <i class="fas fa-chart-line me-2"></i>Residual Plot
                                            </h6>
                                            <p class="text-muted small">Residual harus random tanpa pola (white noise)</p>
                                            <img src="${data.residual_plot}" class="img-fluid rounded" alt="Residual Plot">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${data.residual_acf_plot ? `
                                <div class="col-md-6">
                                    <div class="card border-warning">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold text-warning">
                                                <i class="fas fa-wave-square me-2"></i>ACF Residual
                                            </h6>
                                            <p class="text-muted small">Semua lag harus dalam confidence interval (white noise)</p>
                                            <img src="${data.residual_acf_plot}" class="img-fluid rounded" alt="Residual ACF">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${data.qq_plot ? `
                                <div class="col-md-6">
                                    <div class="card border-warning">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold text-warning">
                                                <i class="fas fa-chart-scatter me-2"></i>Q-Q Plot
                                            </h6>
                                            <p class="text-muted small">Points harus mengikuti garis diagonal (normalitas)</p>
                                            <img src="${data.qq_plot}" class="img-fluid rounded" alt="Q-Q Plot">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    `;
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                    modal.show();
                } else {
                    alert('Data tidak ditemukan');
                }
            })
            .catch(error => {
                console.error('Error fetching detail:', error);
                alert('Error: ' + error.message);
            });
    }

    function viewDataDetail(id) {
        // TODO: Implement detail modal
        alert('Detail untuk Data Update ID: ' + id);
    }

    function viewPredictionDetail(id) {
        // TODO: Implement detail modal
        alert('Detail untuk Prediction ID: ' + id);
    }

    // Confirm clear all
    function confirmClearAll() {
        if (confirm('Apakah Anda yakin ingin menghapus SEMUA riwayat?\n\nPerhatian: Tindakan ini tidak dapat dibatalkan!')) {
            fetch('/api/history/clear', {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('✓ Semua riwayat berhasil dihapus');
                        loadSummary();
                        loadTrainingHistory();
                        loadDataHistory();
                        loadPredictionHistory();
                    } else {
                        alert('✗ Gagal menghapus riwayat: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error clearing history:', error);
                    alert('Error: ' + error.message);
                });
        }
    }
</script>

<style>
    .section-history .card {
        border: none;
        transition: all 0.3s ease;
    }

    .section-history .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .border-4 {
        border-width: 4px !important;
    }

    .table-responsive {
        max-height: 600px;
    }

    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 3px solid transparent;
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: #dee2e6;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
        background-color: transparent;
    }

    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .table td {
        vertical-align: middle;
        font-size: 0.875rem;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    .pagination {
        margin-top: 1rem;
    }

    .toast {
        min-width: 300px;
    }

    code {
        background-color: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.85em;
    }
</style>

{% endblock %}